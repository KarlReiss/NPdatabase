# 服务启动脚本改进说明

## 📝 改进内容

### 1. 端口管理功能

#### 新增功能
- **端口占用检查**：启动前自动检查端口是否被占用
- **端口自动清理**：如果端口被占用，自动终止占用进程
- **端口释放确认**：停止服务后确保端口完全释放

#### 实现细节
```bash
# 新增两个函数
check_port()    # 检查端口是否被占用
kill_port()     # 清理占用端口的进程
```

### 2. 固定端口配置

#### 默认端口设置
- **后端端口**：8080（原来未设置默认值）
- **前端端口**：3001（原来是 5173，改为符合 CLAUDE.md 的 3001）
- **绑定地址**：0.0.0.0（允许外部访问，原来后端未设置，前端是 127.0.0.1）

#### 配置位置
```bash
SERVER_ADDRESS_VALUE="${SERVER_ADDRESS:-0.0.0.0}"
SERVER_PORT_VALUE="${SERVER_PORT:-8080}"
FRONTEND_HOST_VALUE="${FRONTEND_HOST:-0.0.0.0}"
FRONTEND_PORT_VALUE="${FRONTEND_PORT:-3001}"
```

### 3. 启动信息优化

#### 后端启动信息
```
启动 npdb-backend...
  - 端口: 8080
  - 地址: 0.0.0.0
  - 数据库用户: yfguo
npdb-backend 启动成功，PID: xxxxx
访问地址：http://localhost:8080
Swagger文档：http://localhost:8080/swagger-ui.html
日志：/path/to/backend.log
```

#### 前端启动信息
```
启动 npdb-frontend...
  - 端口: 3001
  - 地址: 0.0.0.0
npdb-frontend 启动成功，PID: xxxxx
访问地址：http://localhost:3001
日志：/path/to/frontend.log
```

### 4. 状态显示优化

#### 新的状态格式
```
==========================================
服务状态
==========================================
✓ npdb-backend 运行中
  PID: 12345
  端口: 8080
  访问: http://localhost:8080

✓ npdb-frontend 运行中
  PID: 12346
  端口: 3001
  访问: http://localhost:3001
==========================================
```

### 5. 重启流程优化

#### 改进点
- 添加分隔线和提示信息
- 停止和启动之间增加 3 秒等待时间
- 确保端口完全释放后再启动

### 6. 帮助信息优化

#### 新增内容
- 更清晰的命令说明
- 固定端口配置展示
- 使用示例
- 美化的格式

## 📚 新增文档

### 1. 完整启动指南 (`docs/startup-guide.md`)

**目标用户**：不熟悉编程的用户

**内容包括**：
- ✅ 前置要求检查清单
- 🚀 快速启动步骤（脚本方式 + 手动方式）
- 🛑 停止服务方法
- 🔄 重启服务方法
- 📊 查看服务状态
- 📝 查看日志
- ⚙️ 端口配置说明
- ❓ 常见问题解答（5个常见问题）
- 🔧 高级配置说明
- 📞 获取帮助方式

### 2. 快速启动卡片 (`docs/quick-start.md`)

**目标用户**：熟悉命令行的用户

**内容包括**：
- 🎯 一键启动命令
- 📋 常用命令表格
- 🔧 默认配置
- ❗ 快速故障排查

## 🔍 技术细节

### 端口清理机制

1. **优雅终止**（SIGTERM）
   ```bash
   kill -15 $pid
   ```

2. **等待 2 秒**
   ```bash
   sleep 2
   ```

3. **强制终止**（SIGKILL）
   ```bash
   kill -9 $pid
   ```

4. **验证端口释放**
   ```bash
   lsof -Pi :$port -sTCP:LISTEN
   ```

### 启动等待时间

- **后端启动等待**：3 秒（原来 1 秒）
  - Spring Boot 启动需要更多时间

- **前端启动等待**：3 秒（原来 1 秒）
  - Vite 开发服务器启动需要时间

- **重启间隔等待**：3 秒
  - 确保端口完全释放

## 🎯 使用场景

### 场景 1：首次启动
```bash
bash scripts/backend-service.sh start
```
- 自动检查端口
- 如果端口被占用，自动清理
- 启动服务并显示访问地址

### 场景 2：服务异常需要重启
```bash
bash scripts/backend-service.sh restart
```
- 停止现有服务
- 清理端口
- 等待 3 秒
- 重新启动服务

### 场景 3：检查服务状态
```bash
bash scripts/backend-service.sh status
```
- 显示服务运行状态
- 显示 PID 和端口
- 显示访问地址

### 场景 4：排查问题
```bash
# 查看后端日志
bash scripts/backend-service.sh logs

# 查看前端日志
bash scripts/backend-service.sh logs frontend
```

## ✅ 测试验证

### 测试项目

- [x] 帮助信息显示正常
- [x] 状态命令显示正常
- [x] 端口配置正确（后端 8080，前端 3001）
- [x] 环境变量默认值正确
- [x] 脚本语法无错误

### 待测试项目

- [ ] 启动服务功能
- [ ] 停止服务功能
- [ ] 重启服务功能
- [ ] 端口清理功能
- [ ] 日志查看功能

## 📌 注意事项

1. **lsof 命令依赖**
   - 脚本使用 `lsof` 命令检查端口
   - 如果系统未安装，需要先安装：
     ```bash
     sudo apt-get install lsof  # Ubuntu/Debian
     sudo yum install lsof      # CentOS/RHEL
     ```

2. **权限问题**
   - 如果端口被其他用户的进程占用，可能需要 sudo 权限
   - 建议使用非特权端口（>1024）

3. **数据库配置**
   - 确保数据库用户名和密码正确
   - 默认配置：用户 `yfguo`，密码 `npdb2024`

4. **防火墙设置**
   - 如果需要外部访问，确保防火墙开放相应端口
   - 后端：8080
   - 前端：3001

## 🔗 相关文件

- **脚本文件**：`scripts/backend-service.sh`
- **完整指南**：`docs/startup-guide.md`
- **快速卡片**：`docs/quick-start.md`
- **项目说明**：`CLAUDE.md`
- **后端文档**：`docs/backend-dev-doc.md`

## 📊 改进对比

| 项目 | 改进前 | 改进后 |
|------|--------|--------|
| 端口检查 | ❌ 无 | ✅ 自动检查和清理 |
| 默认端口 | 部分未设置 | ✅ 全部设置固定值 |
| 启动信息 | 简单 | ✅ 详细（端口、地址、访问链接） |
| 状态显示 | 简单文本 | ✅ 格式化表格 |
| 帮助文档 | ❌ 无 | ✅ 完整指南 + 快速卡片 |
| 用户友好度 | 中等 | ✅ 高（面向非技术用户） |

---

**总结**：本次改进使服务启动脚本更加健壮、用户友好，特别适合不熟悉编程的用户使用。
